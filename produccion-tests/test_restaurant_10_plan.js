/**
 * Test espec√≠fico para verificar configuraci√≥n del restaurante ID 10
 * Verificar si tiene plan Enterprise pero est√° restringido seg√∫n plan B√°sico
 */

const axios = require('axios');

class RestaurantPlanTester {
    constructor() {
        this.restaurantId = 10;
        this.results = {};
    }

    async runCompletePlanTest() {
        console.log('üéØ VERIFICACI√ìN COMPLETA DEL RESTAURANTE ID 10');
        console.log('=' .repeat(60));
        console.log('üéØ Objetivo: Verificar discrepancia entre plan Enterprise y restricciones de plan B√°sico');
        console.log('');

        try {
            await this.testDatabaseSchema();
            await this.testPlanConfiguration();
            await this.testSubscriptionStatus();
            await this.testUserPermissions();
            await this.testPlanFeatures();
            await this.testPlanLimits();
            
            this.generatePlanAnalysis();
        } catch (error) {
            console.error('‚ùå Error en pruebas:', error.message);
        }
    }

    async testDatabaseSchema() {
        console.log('üìã 1. VERIFICANDO ESTRUCTURA DE BASE DE DATOS...');
        
        // Simular consultas SQL que deber√≠amos ejecutar
        const sqlQueries = [
            {
                name: 'Verificar estructura tabla restaurantes',
                query: `SELECT * FROM restaurantes WHERE id_restaurante = ${this.restaurantId};`,
                description: 'Datos b√°sicos del restaurante'
            },
            {
                name: 'Verificar estructura tabla suscripciones',
                query: `SELECT * FROM suscripciones WHERE id_restaurante = ${this.restaurantId};`,
                description: 'Suscripciones activas del restaurante'
            },
            {
                name: 'Verificar estructura tabla planes',
                query: `SELECT * FROM planes p 
                        JOIN suscripciones s ON p.id_plan = s.id_plan 
                        WHERE s.id_restaurante = ${this.restaurantId};`,
                description: 'Informaci√≥n del plan asociado'
            },
            {
                name: 'Verificar estructura tabla vendedores',
                query: `SELECT * FROM vendedores WHERE id_restaurante = ${this.restaurantId};`,
                description: 'Usuarios del restaurante'
            }
        ];

        console.log('üîç Consultas SQL requeridas:');
        sqlQueries.forEach((query, index) => {
            console.log(`\n   ${index + 1}. ${query.name}:`);
            console.log(`      üìù ${query.description}`);
            console.log(`      üîß SQL: ${query.query}`);
        });

        console.log('\n‚úÖ Estructura de consultas verificada');
    }

    async testPlanConfiguration() {
        console.log('\nüíé 2. VERIFICANDO CONFIGURACI√ìN DEL PLAN...');
        
        // Simular diferentes escenarios de plan
        const planScenarios = [
            {
                name: 'Escenario 1: Plan Enterprise activo',
                data: {
                    id_restaurante: this.restaurantId,
                    id_plan: 3, // Enterprise
                    estado: 'activa',
                    plan_details: {
                        nombre: 'Enterprise',
                        tipo: 'enterprise',
                        precio: 299.99,
                        features: ['todas_las_funcionalidades']
                    }
                },
                expected: 'Todas las funcionalidades disponibles'
            },
            {
                name: 'Escenario 2: Plan B√°sico activo',
                data: {
                    id_restaurante: this.restaurantId,
                    id_plan: 1, // B√°sico
                    estado: 'activa',
                    plan_details: {
                        nombre: 'B√°sico',
                        tipo: 'basico',
                        precio: 49.99,
                        features: ['funcionalidades_limitadas']
                    }
                },
                expected: 'Funcionalidades restringidas'
            },
            {
                name: 'Escenario 3: Plan expirado',
                data: {
                    id_restaurante: this.restaurantId,
                    id_plan: 3, // Enterprise
                    estado: 'expirado', // Plan expirado
                    plan_details: {
                        nombre: 'Enterprise',
                        tipo: 'enterprise',
                        precio: 299.99,
                        features: ['todas_las_funcionalidades']
                    }
                },
                expected: 'Restricciones por plan expirado'
            },
            {
                name: 'Escenario 4: Sin suscripci√≥n activa',
                data: {
                    id_restaurante: this.restaurantId,
                    suscripciones: []
                },
                expected: 'Sin acceso (plan por defecto)'
            }
        ];

        console.log('üîç Escenarios de plan a verificar:');
        planScenarios.forEach((scenario, index) => {
            console.log(`\n   ${index + 1}. ${scenario.name}:`);
            console.log(`      üéØ Expectativa: ${scenario.expected}`);
            console.log(`      üìä Datos:`, JSON.stringify(scenario.data, null, 8));
        });

        console.log('\n‚ö†Ô∏è POSIBLE PROBLEMA IDENTIFICADO:');
        console.log('   El restaurante puede tener plan Enterprise en la BD,');
        console.log('   pero el frontend est√° aplicando restricciones de plan B√°sico.');
        console.log('');
        console.log('üîç CAUSAS PROBABLES:');
        console.log('   1. Cache del frontend no actualizado');
        console.log('   2. Plan System Context no sincronizado');
        console.log('   3. Middleware de validaci√≥n mal configurado');
        console.log('   4. Discrepancia entre BD y l√≥gica de planes del frontend');
    }

    async testSubscriptionStatus() {
        console.log('\nüìã 3. VERIFICANDO ESTADO DE SUSCRIPCI√ìN...');
        
        // Simular verificaci√≥n de suscripci√≥n
        console.log('üîç Verificaciones necesarias:');
        
        const subscriptionChecks = [
            {
                check: 'Suscripci√≥n activa existe',
                sql: `SELECT COUNT(*) as count FROM suscripciones 
                      WHERE id_restaurante = ${this.restaurantId} AND estado = 'activa';`,
                expected: 'count > 0'
            },
            {
                check: 'Fecha de suscripci√≥n v√°lida',
                sql: `SELECT fecha_inicio, fecha_fin FROM suscripciones 
                      WHERE id_restaurante = ${this.restaurantId} AND estado = 'activa';`,
                expected: 'fecha_fin > CURRENT_DATE'
            },
            {
                check: 'Plan asociado existe',
                sql: `SELECT p.nombre FROM planes p 
                      JOIN suscripciones s ON p.id_plan = s.id_plan 
                      WHERE s.id_restaurante = ${this.restaurantId} AND s.estado = 'activa';`,
                expected: 'nombre = "Enterprise" (par apropiado)'
            },
            {
                check: 'Usuarios del restaurante tienen acceso',
                sql: `SELECT COUNT(*) as usuarios FROM vendedores 
                      WHERE id_restaurante = ${this.restaurantId} AND activo = true;`,
                expected: 'usuarios > 0'
            }
        ];

        subscriptionChecks.forEach((check, index) => {
            console.log(`   ${index + 1}. ${check.check}:`);
            console.log(`      üîß SQL: ${check.sql}`);
            console.log(`      ‚úÖ Esperado: ${check.expected}`);
        });

        console.log('\n‚ö†Ô∏è PROBLEMAS COMUNES EN SUSCRIPCIONES:');
        console.log('   1. Plan cambiado pero usuarios no actualizados');
        console.log('   2. Suscripci√≥n expirada silenciosamente');
        console.log('   3. M√∫ltiples suscripciones causando conflicto');
        console.log('   4. Cache del sistema deplanes desactualizado');
    }

    async testUserPermissions() {
        console.log('\nüë§ 4. VERIFICANDO PERMISOS DE USUARIOS...');
        
        console.log('üîç Aspectos a verificar en usuarios del restaurante 10:');
        
        const permissionChecks = [
            {
                aspect: 'Rol del usuario',
                check: '¬øEs admin/super_admin con acceso completo?',
                sql: `SELECT rol FROM vendedores WHERE id_restaurante = ${this.restaurantId};`
            },
            {
                aspect: 'Estado del usuario',
                check: '¬øEst√° activo y puede acceder?',
                sql: `SELECT activo FROM vendedores WHERE id_restaurante = ${this.restaurantId};`
            },
            {
                aspect: 'Asociaci√≥n restaurante-sucursal',
                check: '¬øEst√° correctamente asociado?',
                sql: `SELECT id_sucursal FROM vendedores WHERE id_restaurante = ${this.restaurantId};`
            },
            {
                aspect: 'Token JWT',
                check: '¬øInclude datos de plan en el payload?',
                note: 'Verificar que authController incluya plan en JWT'
            }
        ];

        permissionChecks.forEach((check, index) => {
            console.log(`   ${index + 1}. ${check.aspect}:`);
            console.log(`      üîç ${check.check}`);
            if (check.sql) {
                console.log(`      üîß SQL: ${check.sql}`);
            }
            if (check.note) {
                console.log(`      üìù ${check.note}`);
            }
        });

        console.log('\n‚ö†Ô∏è PROBLEMAS COMUNES EN PERMISOS:');
        console.log('   1. JWT no incluye informaci√≥n del plan');
        console.log('   2. Rol del usuario no coincide con plan');
        console.log('   3. Usuario inactivo bloqueando acceso');
        console.log('   4. Middleware no valida plan correctamente');
    }

    async testPlanFeatures() {
        console.log('\n‚ö° 5. VERIFICANDO FUNCIONALIDADES DEL PLAN...');
        
        console.log('üîç Funcionalidades a verificar seg√∫n el plan Enterprise:');
        
        const enterpriseFeatures = [
            'Dashboard completo',
            'Reportes avanzados', 
            'Inventario completo',
            'Gesti√≥n de usuarios',
            'Configuraci√≥n avanzada',
            'API completa',
            'Soporte prioritario',
            'Almacenamiento ilimitado',
            'Sin l√≠mites de transacciones'
        ];

        const basicRestrictions = [
            'Dashboard b√°sico',
            'Reportes limitados',
            'Inventario b√°sico', 
            'Gesti√≥n de usuarios limitada',
            'Configuraci√≥n b√°sica',
            'API restringida',
            'Soporte est√°ndar',
            'Almacenamiento limitado',
            'L√≠mites de transacciones'
        ];

        console.log('\nüü¢ FUNCIONALIDADES ENTERPRISE (deber√≠a tener):');
        enterpriseFeatures.forEach((feature, index) => {
            console.log(`   ${index + 1}. ${feature}`);
        });

        console.log('\nüî¥ RESTRICCIONES B√ÅSICO (NO deber√≠a tener):');
        basicRestrictions.forEach((restriction, index) => {
            console.log(`   ${index + 1}. ${restriction}`);
        });

        console.log('\n‚ö†Ô∏è DISCREPANCIA DETECTADA:');
        console.log('   Si el restaurante tiene plan Enterprise pero ve restricciones b√°sicas,');
        console.log('   el problema est√° en la l√≥gica del frontend o middleware del backend.');
    }

    async testPlanLimits() {
        console.log('\nüîí 6. VERIFICANDO L√çMITES DEL PLAN...');
        
        console.log('üîç L√≠mites a verificar en restaurante 10:');
        
        const limitsComparison = {
            basico: {
                max_sucursales: 1,
                max_usuarios: 3,
                max_productos: 100,
                max_transacciones_mes: 500,
                almacenamiento_gb: 5
            },
            enterprise: {
                max_sucursales: 'ilimitado',
                max_usuarios: 'ilimitado', 
                max_productos: 'ilimitado',
                max_transacciones_mes: 'ilimitado',
                almacenamiento_gb: 'ilimitado'
            }
        };

        console.log('\nüìä COMPARACI√ìN DE L√çMITES:');
        console.log('\n üü¢ B√ÅSICO:');
        Object.entries(limitsComparison.basico).forEach(([limit, value]) => {
            console.log(`    ${limit}: ${value}`);
        });

        console.log('\n üü¢ ENTERPRISE:');
        Object.entries(limitsComparison.enterprise).forEach(([limit, value]) => {
            console.log(`    ${limit}: ${value}`);
        });

        console.log('\n‚ö†Ô∏è DIAGN√ìSTICO:');
        console.log('   Si el restaurante 10 tiene l√≠mites b√°sicos cuando deber√≠a tener Enterprise,');
        console.log('   verificar:');
        console.log('   1. Contadores_uso no actualizados');
        console.log('   2. Plan System Context desactualizado');
        console.log('   3. Cache del frontend con datos antiguos');
        console.log('   4. Middleware de validaci√≥n con plan incorrecto');
    }

    generatePlanAnalysis() {
        console.log('\nüìä AN√ÅLISIS FINAL DEL PLAN - RESTAURANTE ID 10');
        console.log('=' .repeat(60));
        
        console.log('\nüéØ HIP√ìTESIS PRINCIPAL:');
        console.log('   El restaurante ID 10 tiene plan Enterprise en la base de datos,');
        console.log('   pero sistema del frontend est√° aplicando restricciones de plan B√°sico.');
        console.log('');
        
        console.log('üîç CAUSAS PROBABLES:');
        console.log('   1. üì∫ Frontend: Plan System Context no sincronizado');
        console.log('   2. üîß Backend: Middleware de validaci√≥n con configuraci√≥n incorrecta');
        console.log('   3. üíæ Cache: Datos del plan en localStorage desactualizados');
        console.log('   4. üóÑÔ∏è BD: Asociaci√≥n restaurante-plan incorrecta');
        console.log('   5. üîê Auth: JWT no incluye informaci√≥n del plan actualizada');
        console.log('');
        
        console.log('üõ†Ô∏è SOLUCIONES PRIORITARIAS:');
        console.log('');
        
        console.log('üìã 1. VERIFICACI√ìN INMEDIATA (Base de Datos):');
        console.log('   SELECT r.nombre, p.nombre as plan, s.estado');
        console.log('   FROM restaurantes r');
        console.log('   JOIN suscripciones s ON r.id_restaurante = s.id_restaurante');
        console.log('   JOIN planes p ON s.id_plan = p.id_plan');
        console.log('   WHERE r.id_restaurante = 10;');
        console.log('');
        
        console.log('üìã 2. VERIFICACI√ìN FRONTEND:');
        console.log('   En consola del navegador:');
        console.log('   üìù console.log(planInfo);');
        console.log('   üìù console.log(currentPlan);');
ÊÄß     
        console.log('üìã 3. VERIFICACI√ìN BACKEND:');
        console.log('   Revisar authController.js:');
        console.log('   üìù ¬øInclude datos del plan en JWT?');
        console.log('   üìù ¬øInclude planInfo en respuestas API?');
        console.log('');
        
        console.log('üìã 4. VERIFICACI√ìN MIDDLEWARE:');
        console.log('   Revisar middleware de validaci√≥n de planes:');
        console.log('   üìù ¬øUsa datos correctos del usuario?');
        console.log('   üìù ¬øConsulte el plan real o datos en cach√©?');
        console.log('');
        
        console.log('üöÄ PASOS SIGUIENTES:');
        console.log('   1. Ejecutar consultas SQL en producci√≥n');
        console.log('   2. Verificar datos en consola del navegador');
        console.log('   3. Revisar c√≥digo authController.js');
        console.log('   4. Actualizar sistema de planes si es necesario');
        console.log('   5. Limpiar cache y reintentar');
        console.log('');
        
        console.log('‚ö†Ô∏è IMPORTANTE:');
        console.log('   Si el plan es Enterprise pero las restricciones son b√°sicas,');
        console.log('   el usuario est√° pagando por funcionalidades que no puede usar.');
        console.log('   Esto requiere soluci√≥n urgente.');
    }
}

// Ejecutar an√°lisis
if (require.main === module) {
    const tester = new RestaurantPlanTester();
    tester.runCompletePlanTest().catch(console.error);
}

module.exports = RestaurantPlanTester;
